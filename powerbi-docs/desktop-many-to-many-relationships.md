---
title: Связи "многие ко многим" в Power BI Desktop
description: Использование связей с кратностью "многие ко многим" в Power BI Desktop
author: davidiseminger
ms.reviewer: ''
ms.service: powerbi
ms.subservice: powerbi-desktop
ms.topic: conceptual
ms.date: 02/13/2019
ms.author: davidi
LocalizationGroup: Transform and shape data
ms.openlocfilehash: 578d5f77753884575111b3247f5aa4d3ae79e179
ms.sourcegitcommit: 64c860fcbf2969bf089cec358331a1fc1e0d39a8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/09/2019
ms.locfileid: "73866816"
---
# <a name="relationships-with-a-many-many-cardinality-in-power-bi-desktop"></a>Связи с кратностью "многие ко многим" в Power BI Desktop

С помощью *связей с кратностью "многие ко многим"* в Power BI Desktop можно соединять таблицы, использующие кратность *многие ко многим*. Это позволяет более простым и интуитивно понятным образом создавать модели данных, которые содержат несколько источников данных. Функция *связей с кратностью "многие ко многим"* является частью более широкого набора возможностей *составных моделей* в Power BI Desktop.

![Отношение "многие ко многим" в области "Изменение связи"](media/desktop-many-to-many-relationships/many-to-many-relationships_01.png)

Возможность создания *связей с кратностью "многие ко многим"* в Power BI Desktop реализована в наборе из трех связанных функций:

* **Составные модели.** Они позволяют включить в отчет несколько подключений к данным в любом сочетании, в том числе подключения DirectQuery или импорт. Дополнительные сведения см. в статье [Составные модели в Power BI Desktop](desktop-composite-models.md).

* **Связи с кратностью "многие ко многим"** . В *составных моделях* вы можете установить между таблицами *связи с кратностью "многие ко многим"* . Они избавляют от необходимости поддерживать уникальные значения в таблицах. Также они позволяют обойтись без предыдущих обходных путей, например создания новых таблиц исключительно для образования связей. Эта функция подробно описана далее в этой статье.

* **Режим хранения** Он позволяет указать, в каких визуальных элементах будут использоваться запросы к источникам данных серверной части. Визуальные элементы, которым не нужны такие запросы, всегда импортируются, даже если они основаны на DirectQuery. Эта функция помогает повысить производительность и снизить нагрузку на серверную часть. Ранее даже простые визуальные элементы, например срезы, инициировали запросы к серверным источникам. Дополнительные сведения см. в статье [Режим хранения в Power BI Desktop (предварительная версия)](desktop-storage-mode.md).

## <a name="what-relationships-with-a-many-many-cardinality-solves"></a>Проблемы, решаемые *связями с кратностью "многие ко многим"*

Прежде чем стали доступны *связи с кратностью "многие ко многим"* , связь между двумя таблицами определялась в Power BI. Хотя бы один из столбцов таблиц, участвующих в связи, должен был содержать уникальные значения. Часто столбцы не содержали уникальные значения. 

Например, в двух таблицах может быть столбец со страной (*Country*), но значения *Country* не являются уникальными ни в одной из таблиц. Чтобы соединить такие таблицы, было необходимо обходное решение. Одно из возможных решений — ввести в модель дополнительные таблицы с необходимыми уникальными значениями. С помощью *связей с кратностью "многие ко многим"* такие таблицы можно соединять непосредственно с помощью связей с кратностью **многие ко многим**.  

## <a name="use-relationships-with-a-many-many-cardinality"></a>Использование *связей с кратностью "многие ко многим"*

При определении связи между двумя таблицами в Power BI необходимо определить кратность связи. Например, связь между *ProductSales* и *Product*&mdash;с использованием столбцов *ProductSales[ProductCode]* и *Product[ProductCode]* &mdash; будет определена как *многие к одному*. Мы определяем связь таким образом, так как есть много продаж для каждого продукта и столбец *(ProductCode)* таблицы *Product* является уникальным. При определении кратности связи как *многие к одному*, *один ко многим* или *один к одному* Power BI проверяет ее, чтобы обеспечить соответствие кратности фактическим данным.

Например, рассмотрим простую модель на следующем изображении.

![Представление связи](media/desktop-many-to-many-relationships/many-to-many-relationships_02.png)

Теперь представим, что в таблице *Product* отображаются лишь две строки, как показано:

![Визуальный элемент с двумя строками таблицы продуктов](media/desktop-many-to-many-relationships/many-to-many-relationships_03.png)

Также представьте таблицу *Sales*, содержащую всего четыре строки, включая строку для продукта C, которого не существует в таблице *Product* из-за ошибки ссылочной целостности.

![Визуальный элемент с четырьмя строками таблицы продаж](media/desktop-many-to-many-relationships/many-to-many-relationships_04.png)

Столбцы *ProductName* и *Price* (из таблицы *Product*), наряду с общим значением *Qty* (количество) для каждого продукта (из таблицы *ProductSales*), будут отображены, как показано на следующем изображении: 

![Визуальный элемент с названием продукта, ценой и количеством](media/desktop-many-to-many-relationships/many-to-many-relationships_05.png)

Как показано на предыдущем рисунке, есть пустая строка *ProductName*, которая связана с продажами продукта C. Она отвечает за следующее:

* Все строки таблицы *ProductSales*, для которых не существует соответствующей строки в таблице *Product*. Существует проблема целостности данных, как показано в этом примере для продукта *C*.

* Любые строки в таблице *ProductSales*, для которых столбец внешнего ключа имеет значение NULL. 

По этим причинам в обоих случаях пустая строка отвечает за продажи, в которых *ProductName* и *Price* неизвестны.

Но иногда бывают случаи, когда таблицы соединены по двум столбцам, и при этом ни один из столбцов не уникален. Например, рассмотрим следующие две таблицы:

* Таблица *Sales* содержит данные о продажах по штатам (*State*), где в каждой строке указан объем продаж, соответствующий типу продаж в указанном штате (включая штаты CA, WA и TX). 

    ![Таблица продаж, отображение продаж по штатам](media/desktop-many-to-many-relationships/many-to-many-relationships_06.png)

* Таблица *CityData* содержит данные по городам, в том числе сведения о населении и штате (включая штаты Калифорния, Вашингтон и Нью-Йорк).

    ![Таблица продаж, отображение города, штата и населения](media/desktop-many-to-many-relationships/many-to-many-relationships_07.png)

Хотя в обеих таблицах есть столбец *State* и имеет смысл создать отчет по общим продажам по штатам, наряду с общей численностью населения в каждом штате, есть и одна проблема: столбец *State* не является уникальным ни в одной из таблиц. 

## <a name="the-previous-workaround"></a>Использовавшийся ранее обходной путь

В версиях Power BI Desktop, предшествующих выпуску от июля 2018 г., пользователи не могли создать прямую связь между такими таблицами. Обычным решением этой проблемы были следующие действия:

* Создание третьей таблицы, содержащей только уникальные идентификаторы штатов (*State*). Это может быть:
  * Вычисляемая таблица (определяется на языке выражений анализа данных [DAX]).
  * Таблица на основе запроса, который определен в редакторе запросов; он может отображать уникальные идентификаторы, извлеченные из одной из таблиц.
  * Объединенный полный набор.

* Связывание двух исходных таблиц с этой новой таблицей производится с помощью обычных связей *многие к одному*.

Можно оставить дополнительную таблицу видимой или скрыть ее, чтобы она не отображалась в списке **Поля**. Если скрыть таблицу, обычно для связей *многие к одному* включается фильтрация в обоих направлениях, что дает возможность использовать *State* любой из таблиц. Последующие кросс-фильтры распространяются и на другую таблицу. Этот подход показан на следующем рисунке:

![Представление связи](media/desktop-many-to-many-relationships/many-to-many-relationships_08.png)

Визуальный элемент с отображением поля *State* (из таблицы *CityData*) вместе с общей численностью населения (*Population*) и общим объемом продаж (*Sales*) будет выглядеть следующим образом.

![Визуальный элемент таблицы](media/desktop-many-to-many-relationships/many-to-many-relationships_09.png)

> [!NOTE]
> При заданном использовании штата из таблицы *CityData* в решении в этой таблице перечисляются только соответствующие штаты (таким образом, штат Техас исключается). Кроме того, в отличие от связей *многие к одному*, хотя итоговая строка содержит весь объем продаж (*Sales*) (включая штат Техас), в подробные сведения не включается пустая строка, отвечающая за такие несовпадающие строки. Аналогично, не будет пустой строки, соответствующей каким-либо продажам (*Sales*), которым соответствует значение NULL поля *State*.

Если также добавить *City* в этот визуальный элемент, хотя население в расчете на значение *City* известно, то значение *Sales*, показанное для *City*, просто повторит значение *Sales* для соответствующего штата *State*. Это обычно происходит при группировании в столбце, не связанном с агрегатными мерами, как показано на следующем рисунке:

![Визуальный элемент таблицы](media/desktop-many-to-many-relationships/many-to-many-relationships_10.png)

Если мы определим новую таблицу *Sales* в качестве сочетания всех *штатов* в этом обходном решение и сделаем ее видимой в списке **Поля**, тот же визуальный элемент будет отображать *штат* (для новой таблицы), общее *население* и общие *продажи*, как показано на следующем рисунке:

![Визуальный элемент таблицы](media/desktop-many-to-many-relationships/many-to-many-relationships_11.png)

Как вы видите, включен штат *TX*&mdash;с данными *продаж*, но неизвестными данными о *населении*,&mdash;и *Нью-Йорк* &mdash;с известным *населением*, но неизвестными данными о *продажах*&mdash;. Этот способ не оптимален и вызывает множество проблем. Благодаря созданию связей с кратностью "многие ко многим" эти проблемы решаются, как описано в следующем разделе.

## <a name="use-relationships-with-a-many-many-cardinality-instead-of-the-workaround"></a>Использование *связей с кратностью "многие ко многим"* вместо обходного пути

Начиная с версии от июля 2018 г., в Power BI Desktop можно напрямую связывать таблицы, например те, которые мы упоминали выше, не прибегая к использованию аналогичных обходных путей. Теперь можно задать кратность связи *многие ко многим*. Этот параметр указывает, что ни одна из таблиц не содержит уникальные значения. При использовании таких связей по-прежнему можно указывать, какая таблица фильтрует другую таблицу, или установить двунаправленную (взаимную) фильтрацию для двух таблиц.  

В Power BI Desktop по умолчанию задается кратность *многие ко многим*, когда программа определяет, что ни одна из таблиц не содержит уникальные значения столбцов, участвующих в связи. В таких случаях отображается предупреждение для подтверждения того, что такая настройка связи является целевым поведением, а не непреднамеренным следствием проблемы с данными. 

Например, при создании связи непосредственно между *CityData* и *Sales*&mdash;, где фильтры должны применяться от *CityData* к *Sales*, в &mdash;Power BI Desktop отображается следующее диалоговое окно **изменения связи**:

![Диалоговое окно изменения связи](media/desktop-many-to-many-relationships/many-to-many-relationships_01.png)

Итоговое **представление связей** будет содержать прямую связь "многие ко многим" между двумя таблицами. Внешний вид таблиц в списке **Поля** и их последующее поведение при создании визуальных элементов аналогично ситуации, в которой мы применили обходной путь. Там мы создали дополнительную скрытую таблицу уникальных *штатов*. Например, как описано в предыдущем разделе, визуальный элемент со *штатами*, *населением* и *продажами* будет отображаться следующим образом:

![Визуальный элемент таблицы](media/desktop-many-to-many-relationships/many-to-many-relationships_12.png)

Основные различия между *связями с кратностью "многие ко многим"* и более распространенными связями *многие к одному* заключается в следующем.

* Значения, показываемые в них, не содержат пустую строку, отвечающую за несовпадающие строки в другой таблице. Кроме того, значения не отвечают за строки, в которых столбец, используемый для связи в другой таблице, имеет значение NULL.
* Использовать функцию `RELATED()` (так как связанными могут быть несколько строк) невозможно.
* При использовании функции `ALL()` в таблице не удаляются фильтры, примененные к другим таблицам, у которых с ней установлена связь "многие ко многим". В предыдущем примере мера, определенная согласно следующему скрипту, не удалит фильтры по столбцам связанной таблицы *CityData*:

    ![Пример скрипта](media/desktop-many-to-many-relationships/many-to-many-relationships_13.png)

    Визуальный элемент с отображением штата (*State*), объема продаж (*Sales*) и общего объема продаж (*Sales total*) будет следующим:

    ![Визуальный элемент таблицы](media/desktop-many-to-many-relationships/many-to-many-relationships_14.png)

Учитывая перечисленные различия, убедитесь, что вычисления, использующие `ALL(\<Table>)`, такие как *% от общей суммы*, возвращают желаемые результаты. 


## <a name="limitations-and-considerations"></a>Рекомендации и ограничения

В этом выпуске для *связей с кратностью "многие ко многим"* и составных моделей есть несколько ограничений.

Следующие (многомерные) источники Live Connect невозможно использовать с составными моделями:

* SAP HANA
* SAP Business Warehouse
* Службы SQL Server Analysis Services
* Наборы данных Power BI
* Azure Analysis Services

При подключении к этим многомерным источникам в режиме DirectQuery невозможно одновременно подключиться к другому источнику DirectQuery или сочетать его с импортированными данными.

Существующие ограничения для DirectQuery по-прежнему применяются при использовании *связей с кратностью "многие ко многим"* . Многие из этих ограничений теперь относятся к отдельным таблицам в зависимости от режима хранения для каждой таблицы. Например, вычисляемый столбец в импортированной таблице может ссылаться на другие таблицы, но вычисляемый столбец в таблице DirectQuery по-прежнему ограничен ссылками только на столбцы той же таблицы. Если какие-то таблицы в пределах модели являются таблицами DirectQuery, к модели в целом применяются и другие ограничения. Например, функции "Краткая аналитика" и "Вопросы и ответы" недоступны в модели, если какая-либо из таблиц в ней используется в режиме хранения DirectQuery. 

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о составных моделях и DirectQuery см. в следующих статьях:
* [Составные модели в Power BI Desktop](desktop-composite-models.md)
* [Режим хранения в Power BI Desktop (предварительная версия)](desktop-storage-mode.md)
* [Использование DirectQuery в Power BI Desktop](desktop-directquery-about.md)
* [Источники данных, поддерживаемые DirectQuery в Power BI Desktop](desktop-directquery-data-sources.md)
