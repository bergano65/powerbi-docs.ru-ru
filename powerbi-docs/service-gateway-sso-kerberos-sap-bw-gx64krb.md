---
title: Единый вход Kerberos в SAP BW с использованием gx64krb5
description: Настройка сервера SAP BW для включения единого входа из службы Power BI с использованием gx64krb5
author: mgblythe
ms.author: mblythe
manager: kfile
ms.reviewer: ''
ms.service: powerbi
ms.subservice: powerbi-gateways
ms.topic: conceptual
ms.date: 08/01/2019
LocalizationGroup: Gateways
ms.openlocfilehash: 4932f00fa7585c6b4f9186c29b65700d7a14fbea
ms.sourcegitcommit: 9bf3cdcf5d8b8dd12aa1339b8910fcbc40f4cbe4
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/05/2019
ms.locfileid: "71968706"
---
# <a name="use-kerberos-for-single-sign-on-sso-to-sap-bw-using-gx64krb5"></a>Единый вход Kerberos в SAP BW с использованием gx64krb5

В этой статье описывается, как настроить источник данных SAP BW для включения единого входа из службы Power BI с использованием gx64krb5.

> [!NOTE]
> Чтобы включить обновление отчетов на основе сервера приложений SAP BW, использующих единый вход в службе Power BI, можно выполнить действия, описанные в этой статье, в дополнение к действиям, приведенным в статье [Настройка единого входа на основе Kerberos](service-gateway-sso-kerberos.md). Тем не менее корпорация Майкрософт рекомендует использовать CommonCryptoLib в качестве библиотеки SNC вместо gx64krb5. SAP больше не предоставляет поддержку библиотеки gx64krb5, а действия по ее настройке для использования со шлюзом значительно сложнее по сравнению с CommonCryptoLib. Дополнительные сведения по настройке единого входа с помощью CommonCryptoLi см. в статье [Использование единого входа Kerberos для SAP BW с помощью CommonCryptoLib (sapcrypto.dll)](service-gateway-sso-kerberos-sap-bw-commoncryptolib.md). Необходимо настроить только CommonCryptoLib _или_ gx64krb5. Не выполняйте настройку обеих библиотек.

### <a name="set-up-gx64krb5-on-gateway-machine-and-the-sap-bw-server"></a>Настройка gx64krb5 на компьютере шлюза и сервере SAP BW
Это руководстве включает все возможные подробности. Если вы уже выполнили часть этих действий, их можно пропустить. Возможно, вы уже настроили сервер SAP BW для реализации единого входа с использованием gx64krb5.

### <a name="set-up-gx64krb5-on-the-gateway-machine-and-the-sap-bw-server"></a>Настройка gx64krb5 на компьютере шлюза и сервере SAP BW

> [!NOTE]
> `gx64krb5` больше не поддерживается в SAP. Для получения дополнительных сведений см. [Заметку SAP 352295](https://launchpad.support.sap.com/#/notes/352295). Также обратите внимание, что `gx64krb5` не позволяет осуществлять подключения с единым входом от шлюза данных к серверам сообщений SAP BW. Возможны только подключения к серверам приложений SAP BW. Это ограничение только для сервера приложений не применяется, если в качестве библиотеки SNC используется [CommonCryptoLib](service-gateway-sso-kerberos-sap-bw-commoncryptolib.md). Другие библиотеки SNC также могут работать с единым входом для BW, но официально не поддерживаются корпорацией Майкрософт.

Чтобы выполнить подключение с помощью единого входа через шлюз, на сервере и на клиенте должна быть установлена библиотека `gx64krb5` (т. е. клиент и сервер должны использовать одну и ту же библиотеку SNC).

1. Скачайте `gx64krb5` из [примечания SAP 2115486](https://launchpad.support.sap.com/) (требуется s-пользователь SAP). Убедитесь в наличии версии не ниже 1.0.11.x. Если требуется проверить подключение с помощью единого входа в графическом интерфейсе SAP GUI перед попыткой установки этого подключения через шлюз (рекомендуется), также скачайте `gsskrb5` (32-разрядную версию библиотеки). Для тестирования в графическом интерфейсе SAP GUI требуется 32-разрядная версия, так как этот интерфейс доступен только в 32-разрядной версии.

1. Поместите `gx64krb5` в такое расположение на компьютере шлюза, которое доступно пользователю службы шлюза. Если вы хотите протестировать подключение для единого входа с использованием SAP GUI, также необходимо поместить копию `gsskrb5` на компьютер и задать указатель на эту библиотеку в переменной среды **SNC_LIB**. Как пользователь службы шлюза, так и пользователь Active Directory (AD), которого пользователь службы будет олицетворять, должны иметь разрешения на чтение и выполнение для копии библиотеки `gx64krb5`. Рекомендуется предоставить разрешения на доступ к DLL-файлу группе пользователей, прошедших проверку подлинности. В целях тестирования можно также явно предоставить эти разрешения пользователю службы шлюза и пользователю Active Directory, который будет использоваться для тестирования.

1. Если на сервере BW еще не настроен единый вход с помощью gx64krb5, перенесите на компьютер сервера SAP BW еще одну копию DLL-файла в расположение, доступное для сервера SAP BW. Дополнительные сведения о настройке gx64krb5 для работы с сервером SAP BW см. в [документации SAP](https://launchpad.support.sap.com/#/notes/2115486) (необходимы права пользователя s-user).

1. На клиентских и серверных компьютерах задайте переменные среды `SNC_LIB` и/или `SNC_LIB_64`. При использовании gsskrb5 задайте для переменной `SNC_LIB` абсолютный путь к файлу gsskrb5.dll. При использовании gx64krb5 задайте для переменной `SNC_LIB_64` абсолютный путь к файлу gx64krb5.dll.

### <a name="configure-an-sap-bw-service-user-and-enable-snc-communication-on-the-bw-server"></a>Настройка пользователя службы SAP BW и включение обмена данными SNC на сервере BW

Выполните инструкции, приведенные в этом разделе, если вы еще не настроили сервер SAP BW для обмена данными SNC (например, единый вход) с помощью gx64krb5.

> [!NOTE]
> В этом разделе предполагается, что вы уже создали пользователя службы для BW и связали с ним подходящее имя пользователя службы (например, что-либо, что начинается с `SAP/`).

1. Предоставьте пользователю службы доступ к серверу приложений SAP BW:

    1. На сервере SAP BW добавьте пользователя службы в группу локальных администраторов. Откройте программу "Управление компьютером" и определите группу локальных администраторов своего сервера. Например.

        ![Снимок экрана: программа "Управление компьютером"](media/service-gateway-sso-kerberos/computer-management.png)

    1. Дважды щелкните группу локальных администраторов, а затем выберите команду **Добавить**, чтобы добавить пользователя службы в группу. Выберите **Проверить имена**, чтобы убедиться, правильно ли вы ввели имя. Нажмите кнопку **ОК**.

1. Задайте пользователя службы сервера SAP BW в качестве пользователя, который запускает службу сервера SAP BW на серверном компьютере SAP BW.

    1. Откройте окно **Выполнить** и введите **Services.msc**. Найдите службу, соответствующую экземпляру сервера приложений SAP BW. Щелкните ее правой кнопкой мыши и выберите **Свойства**.

        ![Снимок экрана: службы с выделенным пунктом "Свойства"](media/service-gateway-sso-kerberos/server-properties.png)

    1. Перейдите на вкладку **Вход** и измените пользователя на пользователя службы SAP BW. Введите пароль пользователя и нажмите кнопку **ОК**.

1. Войдите на сервер через SAP Logon и задайте следующие параметры профиля с помощью транзакции RZ10:

    1. Задайте значение параметра профиля **snc/identity/as** как *p:&lt;имя пользователя службы SAP BW, только что созданного вами&gt;* , например *p:BWServiceUser\@MYDOMAIN.COM*. Обратите внимание на элемент "p:", предшествующий имени субъекта-пользователя службы. Здесь не используется "p:CN=", как при использовании Common Crypto Lib в качестве библиотеки SNC.

    1. Присвойте параметру профиля **snc/gssapi\_lib** значение *&lt;пути к файлу gx64krb5.dll на компьютере сервера BW&gt;* . Не забудьте поместить библиотеку в расположение, доступное серверу приложений SAP BW.

    1. Также задайте следующие дополнительные параметры профиля, изменив значения по необходимости. Обратите внимание, что последние пять параметров позволяют клиентам подключиться к серверу SAP BW через SAP Logon без необходимости настройки SNC.

        | **Параметр** | **Значение** |
        | --- | --- |
        | snc/data\_protection/max | 3 |
        | snc/data\_protection/min | 1 |
        | snc/data\_protection/use | 9 |
        | snc/accept\_insecure\_cpic | 1 |
        | snc/accept\_insecure\_gui | 1 |
        | snc/accept\_insecure\_r3int\_rfc | 1 |
        | snc/accept\_insecure\_rfc | 1 |
        | snc/permit\_insecure\_start | 1 |

    1. Присвойте свойству **snc/enable** значение 1.

1. Задав эти параметры профиля, откройте консоль управления SAP на сервере и перезапустите экземпляр SAP BW. Если сервер не запускается, убедитесь, что параметры профиля заданы правильно. Дополнительные сведения о настройке параметров профиля см. в [документации по SAP](https://help.sap.com/saphelp_nw70ehp1/helpdata/en/e6/56f466e99a11d1a5b00000e835363f/frameset.htm). Если у вас возникли проблемы, можно также обратиться к сведениям об устранении неполадок далее в этом разделе.

### <a name="map-a-sap-bw-user-to-an-active-directory-user"></a>Сопоставление пользователя SAP BW с пользователем Active Directory

Сопоставьте пользователя Active Directory с пользователем сервера приложений SAP BW и проверьте подключение единого входа в SAP Logon, если вы это еще не сделали.

1. Войдите на сервер SAP BW с помощью SAP Logon. Выполните транзакцию SU01.

1. В поле **Пользователь** введите имя пользователя SAP BW, для которого вы хотите включить единый вход (на снимке экрана выше мы готовимся задать разрешения для пользователя BIUSER). Выберите значок **Изменить** (изображение пера) рядом с левой верхней частью окна входа в систему SAP.

    ![Снимок экрана: экран обслуживания пользователя SAP BW](media/service-gateway-sso-kerberos/user-maintenance.png)

1. Выберите вкладку **SNC**. В поле ввода имени SNC введите *p:&lt;ваше имя пользователя Active Directory&gt;@&lt;домен&gt;* . Обратите внимание на обязательные символы "p:", которые должны предшествовать имени субъекта-пользователя Active Directory. Указанная вами учетная запись пользователя Active Directory должна принадлежать лицу или организации, которым вы хотите включить единый вход для доступа к серверу приложений SAP BW. Например, если вы хотите включить единый вход для пользователя *testuser\@TESTDOMAIN.COM*, введите *p:testuser\@TESTDOMAIN.COM*.

    ![Снимок экрана: экран обслуживания пользователей SAP BW](media/service-gateway-sso-kerberos/maintain-users.png)

1. Выберите значок **Сохранить** (изображение гибкого диска) в левом верхнем углу экрана.

### <a name="test-sign-in-via-sso"></a>Тестирование единого входа

Убедитесь, что можно войти на сервер через SAP Logon с помощью единого входа от имени пользователя Active Directory, для которого вы только что включили доступ с единым входом.

1. Войдите в систему на компьютере в вашем домене, где установлен SAP Logon, от имени пользователя Active Directory, для которого вы только что включили доступ с единым входом. Запустите SAP Logon и создайте подключение.

1. Скопируйте ранее скачанный DLL-файл `gsskrb5` на компьютер, в систему которого вы только что вошли. Присвойте переменной среды `SNC_LIB` значение абсолютного пути к расположению этого файла.

1. Запустите SAP Logon и создайте подключение.

1. На экране **Создать новую системную запись** выберите **Указанная пользователем система** и нажмите **Далее**.

    ![Снимок экрана: экран "Создать новую системную запись"](media/service-gateway-sso-kerberos/new-system-entry.png)

1. Введите соответствующие сведения на следующем экране, включая сервер приложений, номер экземпляра и идентификатор системы. Нажмите кнопку **Готово**.

1. Щелкните правой кнопкой мыши новое подключение и выберите **Свойства**. Откройте вкладку **Сеть**. В текстовом поле **Имя SNC** введите *p:&lt;имя участника-пользователя службы SAP BW&gt;* , например *p:BWServiceUser\@MYDOMAIN.COM*. Нажмите кнопку **ОК**.

    ![Снимок экрана: экран "Свойства для системной записи"](media/service-gateway-sso-kerberos/system-entry-properties.png)

1. Дважды щелкните только что созданное подключение, чтобы выполнить единый вход на сервер SAP BW. Если подключение будет установлено успешно, переходите к следующему шагу. В противном случае просмотрите шаги ранее в этом документе, чтобы убедиться в том, что они были завершены правильно, или обратитесь к разделу по устранению неполадок. Обратите внимание, что если не удается подключиться к серверу SAP BW с помощью единого входа в этом контексте, вы не сможете подключиться к серверу SAP BW с помощью единого входа в контексте шлюза.

### <a name="add-registry-entries-to-the-gateway-machine"></a>Добавление записей реестра на компьютере шлюза

Добавьте необходимые записи в реестр компьютера, на котором установлен шлюз, а также в реестры компьютеров, к которым будет устанавливаться подключение из Power BI Desktop. Выполните следующие команды:

1. ```REG ADD HKLM\SOFTWARE\Wow6432Node\SAP\gsskrb5 /v ForceIniCredOK /t REG_DWORD /d 1 /f```

1. ```REG ADD HKLM\SOFTWARE\SAP\gsskrb5 /v ForceIniCredOK /t REG_DWORD /d 1 /f```

### <a name="add-a-new-sap-bw-application-server-data-source-to-the-power-bi-service-or-edit-an-existing-one"></a>Добавление нового источника данных сервера приложений SAP BW в службу Power BI или изменение имеющегося

1. Введите в окне настройки источника данных **Имя узла** сервера приложений, **Номер системы** и **Идентификатор клиента**, как и в случае входа на сервер SAP BW из Power BI Desktop.

1. В поле **Имя партнера SNC** введите *p:&lt;имя субъекта-службы, которое вы сопоставили с пользователем службы SAP BW&gt;* . Например, для имени субъекта-службы **SAP/BWServiceUser\@MYDOMAIN.COM** следует ввести *p:SAP/BWServiceUser\@MYDOMAIN.COM* в поле **Имя партнера SNC**.

1. В качестве библиотеки SNC выберите **SNC\_LIB** или **SNC\_LIB\_64**. Убедитесь, что **SNC\_LIB\_64** на компьютере шлюза указывает на gx64krb5.dll. Кроме того, можно выбрать параметр "Пользовательский" и указать абсолютный путь к gx64krb5.dll (на компьютере шлюза).

1. Установите флажок **Использовать единый вход (SSO) через Kerberos для запросов DirectQuery** и щелкните **Применить**. Если проверка подключения не была успешной, убедитесь, что предыдущие шаги установки и настройки были выполнены правильно.

1. [Запуск отчета Power BI](service-gateway-sso-kerberos.md#run-a-power-bi-report)

## <a name="troubleshooting"></a>Устранение неполадок

### <a name="troubleshoot-gx64krb5-configuration"></a>Устранение неполадок конфигурации gx64krb5

Если возникнут проблемы, выполните следующие действия для устранения неполадок, связанных с установкой gx64krb5 и подключениями единого входа.

* Просмотр журналов сервера (...work\dev\_w0 на сервере) может быть полезен для устранения ошибок, которые возникают при установке gx64krb5. Это особенно актуально в случае, если сервер SAP BW не запускается после изменения параметров профиля.

* Если вам не удается запустить службу SAP BW из-за ошибки входа в систему, возможно, вы указали неправильный пароль при вводе имени пользователя запуска от имени для SAP BW. Проверьте пароль, войдя на компьютер в среде Active Directory в качестве пользователя службы SAP BW.

* Если возникают сообщения о том, что учетные данные базового источника данных (например, SQL Server) не позволяют запустить сервер, убедитесь, что вы предоставили пользователю службы доступ к базе данных SAP BW.

* Может появиться следующее сообщение: *(GSS-API) указано неизвестное расположение или оно недоступно.* Обычно это означает, что у вас указано неверное имя SNC. Используйте в клиентском приложении только "p:", но не "p:CN =" или что-нибудь еще, отличное от имени субъекта-пользователя службы.

* Может появиться следующее сообщение: *(GSS-API) указано недопустимое имя.* Убедитесь, что символы "p:" присутствуют в начале параметра профиля удостоверения SNC на сервере.

* Может появиться следующее сообщение: *(Ошибка SNC) не найден указанный модуль.* Обычно это происходит, если поместить `gx64krb5.dll` в расположение, где для доступа требуются повышенные привилегии (права администратора).

### <a name="troubleshoot-gateway-connectivity-issues"></a>Устранение проблем с подключением шлюза

1. Проверьте журналы шлюза. Откройте приложение настройки шлюза и выберите **Диагностика**, а затем **Экспортировать журналы**. Самые последние ошибки указаны в конце файлов журнала.

    ![Снимок экрана: приложение локального шлюза данных с выделенным пунктом "Диагностика"](media/service-gateway-sso-kerberos/gateway-diagnostics.png)

1. Включите трассировку SAP BW и просмотрите созданные файлы журналов. Существует несколько различных типов трассировки SAP BW (например, трассировка CPIC). Дополнительные сведения см. в документации по SAP.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о **локальном шлюзе данных** и **DirectQuery** см. в следующих ресурсах:

* [Что такое локальный шлюз данных?](/data-integration/gateway/service-gateway-onprem)
* [Power BI и DirectQuery](desktop-directquery-about.md)
* [Источники данных, поддерживаемые DirectQuery](desktop-directquery-data-sources.md)
* [Использование DirectQuery и SAP Business Warehouse (BW)](desktop-directquery-sap-bw.md)
* [DirectQuery и SAP HANA](desktop-directquery-sap-hana.md)
