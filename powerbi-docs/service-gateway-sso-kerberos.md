---
title: Настройка единого входа (Kerberos)
description: Настройте шлюз с Kerberos, чтобы включить единый вход из Power BI в локальные источники данных
author: mgblythe
ms.author: mblythe
manager: kfile
ms.reviewer: ''
ms.service: powerbi
ms.subservice: powerbi-gateways
ms.topic: conceptual
ms.date: 07/15/2019
LocalizationGroup: Gateways
ms.openlocfilehash: 0fb52262790c6c1935d8152f043f726a9471817d
ms.sourcegitcommit: 9bf3cdcf5d8b8dd12aa1339b8910fcbc40f4cbe4
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/05/2019
ms.locfileid: "71968960"
---
# <a name="configure-kerberos-based-sso-from-power-bi-service-to-on-premises-data-sources"></a>Настройка единого входа на основе Kerberos из службы Power BI в локальные источники данных

Используйте [ограниченное делегирование Kerberos](/windows-server/security/kerberos/kerberos-constrained-delegation-overview), чтобы легко настроить единый вход. Включение единого входа позволяет отчетам и панелям мониторинга Power BI легко обновлять данные из локальных источников с учетом разрешений, настроенных для таких источников на уровне пользователей.

Чтобы ограниченное делегирование Kerberos работало правильно, необходимо настроить несколько элементов, в том числе _имена субъектов-служб_ и параметры делегирования в учетных записях служб.

### <a name="prerequisite-1-install-and-configure-the-microsoft-on-premises-data-gateway"></a>Необходимое условие 1. Установка и настройка локального шлюза данных Майкрософт

Локальный шлюз данных поддерживает обновление на месте, а также _применение параметров_ из существующих шлюзов.

### <a name="prerequisite-2-run-the-gateway-windows-service-as-a-domain-account"></a>Необходимое условие 2. Запуск службы Windows для шлюза в качестве учетной записи домена

В стандартной установке шлюз выполняет роль учетной записи службы для локального компьютера (например, _NT Service\PBIEgwService_). Пример представлен на следующем изображении:

![Снимок экрана: учетная запись службы](media/service-gateway-sso-kerberos/service-account.png)

Чтобы включить ограниченное делегирование Kerberos, шлюз необходимо запускать как учетную запись домена, если только экземпляр Azure Active Directory (Azure AD) не синхронизирован с локальным экземпляром Active Directory (с помощью Azure AD DirSync/Connect). Чтобы переключиться на учетную запись домена, ознакомьтесь со статьей [Смена учетной записи службы шлюза](/data-integration/gateway/service-gateway-service-account).

> [!NOTE]
> Если настроено средство Azure AD Connect и учетные записи пользователей синхронизированы, службе шлюза не требуется выполнять поиск в локальном экземпляре Azure AD во время выполнения. Вместо этого можно просто применить идентификатор безопасности локальной службы в службе шлюза, чтобы выполнить все необходимые настройки в Azure Active Directory. Этапы настройки ограниченного делегирования Kerberos, описанные в этой статье, будут для этой конфигурации такими же, как и в контексте Azure Active Directory. Здесь они просто применяются к объекту-компьютеру шлюза (который определяется по идентификатору безопасности локальной службы) в Azure AD, а не к учетной записи домена.

### <a name="prerequisite-3-have-domain-admin-rights-to-configure-spns-setspn-and-kerberos-constrained-delegation-settings"></a>Необходимое условие 3. Получение прав администратора домена для настройки параметров ограниченного делегирования Kerberos и имен субъектов-служб (SetSPN)

Мы не рекомендуем администраторам доменов временно или постоянно разрешать любому пользователю без прав администратора домена настраивать делегирование Kerberos и имена субъектов-служб. В следующем разделе более подробно описаны рекомендуемые этапы настройки.

## <a name="configure-kerberos-constrained-delegation-for-the-gateway-and-data-source"></a>Настройка ограниченного делегирования Kerberos для шлюза и источника данных

Войдите как администратор домена, настройте имя субъекта-службы для учетной записи домена службы шлюза (если нужно), а также параметры делегирования в этой учетной записи.

### <a name="configure-an-spn-for-the-gateway-service-account"></a>Настройка имени субъекта-службы для учетной записи службы шлюза

Сначала определите, создано ли имя субъекта-службы для учетной записи домена, используемой в качестве учетной записи службы шлюза.

1. Войдите как администратор домена и запустите средство **Пользователи и компьютеры Active Directory**.

2. Щелкните правой кнопкой мыши домен, выберите **Найти** и введите имя учетной записи службы шлюза.

3. В результатах поиска щелкните правой кнопкой мыши учетную запись службы шлюза и выберите **Свойства**.

4. Если в диалоговом окне **Свойства** отображается вкладка **Делегирование**, значит, имя субъекта-службы уже создано и вы можете перейти к [выбору стандартного или основанного на ресурсах режима для ограниченного делегирования Kerberos](#decide-on-resource-based-or-standard-kerberos-constrained-delegation).

    Если в диалоговом окне **Свойства** не отображается вкладка **Делегирование**, можно вручную создать имя субъекта-службы для этой учетной записи. Используйте [средство setspn](https://technet.microsoft.com/library/cc731241.aspx), входящее в состав Windows (для создания имени субъекта-службы нужны права администратора домена).

    Предположим, что используется учетная запись службы шлюза **Contoso\GatewaySvc**, а шлюз работает на компьютере **MyGatewayMachine**. Чтобы задать имя субъекта-службы для этой учетной записи службы шлюза, выполните следующую команду:

    ![Изображение команды для задания имени субъекта-службы](media/service-gateway-sso-kerberos/set-spn.png)

    Чтобы задать имя субъекта-службы, можно использовать оснастку MMC "Пользователи и компьютеры Active Directory".

### <a name="decide-on-resource-based-or-standard-kerberos-constrained-delegation"></a>Решение о выборе стандартного или основанного на ресурсах режима для ограниченного делегирования Kerberos

В параметрах делегирования можно указать _один из двух вариантов:_ ограниченное делегирование Kerberos на основе ресурсов или стандартное ограниченное делегирование Kerberos. Используйте делегирование на основе ресурсов, если источник данных и шлюз расположены в разных доменах. Но учтите, что для этого варианта требуется использовать Windows Server 2012 или более поздней версии. Дополнительные сведения о различиях между двумя подходами к делегированию см. на странице [общих сведений об ограниченном делегировании Kerberos](/windows-server/security/kerberos/kerberos-constrained-delegation-overview).

 Когда вы решите, какой подход будете использовать, перейдите к разделу _либо_ [о настройке учетной записи службы шлюза для стандартного ограниченного делегирования Kerberos](#configure-the-gateway-service-account-for-standard-kerberos-constrained-delegation), _либо_ [о настройке учетной записи службы шлюза для ограниченного делегирования Kerberos на основе ресурсов](#configure-the-gateway-service-account-for-resource-based-kerberos-constrained-delegation). Не выполняйте оба этих подраздела.

## <a name="configure-the-gateway-service-account-for-standard-kerberos-constrained-delegation"></a>Настройка учетной записи службы шлюза для стандартного ограниченного делегирования Kerberos

> [!NOTE]
> Инструкции из этого раздела следует выполнять, если вы решили настроить стандартное ограниченное делегирование Kerberos. Если вы хотите применить ограниченное делегирование Kerberos на основе ресурсов, выполните действия из раздела [Настройка учетной записи службы шлюза для ограниченного делегирования Kerberos на основе ресурсов](#configure-the-gateway-service-account-for-resource-based-kerberos-constrained-delegation).

Сейчас мы настроим параметры делегирования для учетной записи домена службы шлюза. Для этого можно использовать разные средства. Здесь мы будем использовать средство "Пользователи и компьютеры Active Directory", которое является оснасткой консоли управления (MMC). Это средство используется для администрирования и публикации данных в каталоге. По умолчанию оно доступно на контроллерах домена, но его можно включить и на других компьютерах с помощью средства настройки компонентов Windows.

Нужно настроить ограниченное делегирование Kerberos с транзитом протокола. При использовании ограниченного делегирования необходимо явно указать службы, которым вы разрешите предоставлять делегированные учетные данные от шлюза. Например, только SQL Server либо сервер SAP HANA принимает вызовы делегирования от учетной записи службы шлюза.

В этом разделе предполагается, что вы уже настроили имена субъектов-служб для ваших базовых источников данных (таких как SQL Server, SAP HANA, SAP BW, Teradata и Spark). Чтобы узнать, как настроить имена субъектов-служб сервера источника данных, см. техническую документацию соответствующего сервера базы данных. Также можно ознакомиться с разделом о том, *какое имя субъекта-службы требуется вашему приложению*, в записи блога [My Kerberos Checklist](https://techcommunity.microsoft.com/t5/SQL-Server-Support/My-Kerberos-Checklist-8230/ba-p/316160) (Мой контрольный список по Kerberos).

В следующих шагах предполагается, что вы используете локальную среду с двумя компьютерами в одном домене: компьютер шлюза и сервер баз данных с SQL Server, на котором уже настроен единый вход на основе Kerberos. Эти действия можно скорректировать для любого из других поддерживаемых источников данных, если для него уже настроен единый вход на основе Kerberos. Для примера мы также предположим следующие параметры и имена:

* Домен Active Directory (Netbios): **Contoso**
* Имя компьютера шлюза: **MyGatewayMachine**
* Учетная запись службы шлюза: **Contoso\GatewaySvc**
* Имя компьютера источника данных SQL Server: **TestSQLServer**
* Учетная запись для службы источника данных SQL Server: **Contoso\SQLService**

Ниже описано, как настроить параметры делегирования:

1. Войдите как администратор домена и откройте **Пользователи и компьютеры Active Directory**.

2. Щелкните правой кнопкой мыши учетную запись службы шлюза (**Contoso\GatewaySvc**) и выберите **Свойства**.

3. Выберите вкладку **Делегирование**.

4. Выберите параметр **Доверять компьютеру делегирование указанных служб** > **Использовать любой протокол проверки подлинности**.

5. В разделе **Службы, с которыми эта учетная запись может использовать делегированные учетные данные** нажмите кнопку **Добавить**.

6. В открывшемся диалоговом окне выберите **Пользователи или компьютеры**.

7. Введите сведения об учетной записи службы для источника данных, например, источник данных SQL Server может иметь такую учетную запись службы, как **Contoso\SQLService**. Для этой учетной записи должно быть задано соответствующее имя субъекта-службы для источника данных. После добавления учетной записи нажмите кнопку **ОК**.

8. Выберите имя субъекта-службы, созданное для сервера базы данных. В этом примере имя субъекта-службы начинается с **MSSQLSvc**. Если вы добавили полное доменное имя и имя субъекта-службы NetBIOS для службы базы данных, выберите оба имени. Вы можете увидеть только одно имя.

9. Нажмите кнопку **ОК**. Теперь имя субъекта-службы должно отображаться в списке служб, которым учетная запись службы шлюза может предоставлять делегированные учетные данные.

    ![Снимок экрана: диалоговое окно свойств соединителя шлюза](media/service-gateway-sso-kerberos/gateway-connector-properties.png)

Теперь перейдите к разделу [о предоставлении учетной записи службы шлюза прав на локальные политики на компьютере шлюза](#grant-the-gateway-service-account-local-policy-rights-on-the-gateway-machine), чтобы продолжить процесс установки.

## <a name="configure-the-gateway-service-account-for-resource-based-kerberos-constrained-delegation"></a>Настройка учетной записи службы шлюза для ограниченного делегирования Kerberos на основе ресурсов

> [!NOTE]
> Инструкции из этого раздела следует выполнять, если вы решили настроить ограниченное делегирование Kerberos на основе ресурсов. Если вы хотите применить стандартное ограниченное делегирование Kerberos, выполните действия из раздела [Настройка учетной записи службы шлюза для стандартного ограниченного делегирования Kerberos](#configure-the-gateway-service-account-for-standard-kerberos-constrained-delegation).

Используйте [ограниченное делегирование Kerberos на основе ресурсов](/windows-server/security/kerberos/kerberos-constrained-delegation-overview), чтобы обеспечить возможность подключения с единым входом для Windows Server версии 2012 и выше, разместив интерфейсные и серверные службы в разных доменах. Для этого домен серверной службы должен соответствовать домену интерфейсной службы.

В следующих шагах предполагается, что вы используете локальную среды с двумя компьютерами в разных доменах: компьютер шлюза и сервер баз данных с SQL Server, на котором уже настроен единый вход на основе Kerberos. Эти действия можно скорректировать для любого из других поддерживаемых источников данных, если для него уже настроен единый вход на основе Kerberos. Для примера используем параметры и имена, указанные ниже.

* Домен переднего плана Active Directory (Netbios): **ContosoFrontEnd**
* Внутренний домен Active Directory (Netbios): **ContosoBackEnd**
* Имя компьютера шлюза: **MyGatewayMachine**
* Учетная запись службы шлюза: **ContosoFrontEnd\GatewaySvc**
* Имя компьютера источника данных SQL Server: **TestSQLServer**
* Учетная запись для службы источника данных SQL Server: **ContosoBackEnd\SQLService**

Выполните описанные ниже шаги по настройке, используя имена и значения из этого примера.

1. Используя оснастку MMC **Пользователи и компьютеры Active Directory** в контроллере домена для домена **ContosoFrontEnd** убедитесь, что параметры делегирования не применяются для учетной записи службы шлюза.

    ![Свойства соединителя шлюза](media/service-gateway-sso-kerberos-resource/gateway-connector-properties.png)

2. Используя оснастку **Пользователи и компьютеры Active Directory** в контролере домена для домена **ContosoBackEnd** убедитесь, что параметры делегирования не применяются для учетной записи серверной службы.

    ![Свойства службы SQL](media/service-gateway-sso-kerberos-resource/sql-service-properties.png)

3. Кроме того, убедитесь, что для этой учетной записи не задан атрибут **msDS-AllowedToActOnBehalfOfOtherIdentity**. Этот атрибут можно проверить в **редакторе атрибутов**, как показано на изображении ниже.

    ![Атрибуты службы SQL](media/service-gateway-sso-kerberos-resource/sql-service-attributes.png)

4. Создайте группу **Пользователи и компьютеры Active Directory** в контроллере домена для домена **ContosoBackEnd**. Добавьте учетную запись службы шлюза в эту группу, как показано на рисунке ниже. На изображении показаны новая группа под названием _ResourceDelGroup_ и учетная запись службы шлюза **GatewaySvc**, добавленная в эту группу.

    ![Свойства группы](media/service-gateway-sso-kerberos-resource/group-properties.png)

5. Откройте командную строку и выполните следующие команды в контроллере домена для домена **ContosoBackEnd**, чтобы обновить атрибут **msDS-AllowedToActOnBehalfOfOtherIdentity** для учетной записи серверной службы:

    ```powershell
    $c = Get-ADGroup ResourceDelGroup
    Set-ADUser SQLService -PrincipalsAllowedToDelegateToAccount $c
    ```

6. Можно убедиться, что обновление отображается на вкладке редактора атрибутов в разделе свойств для учетной записи серверной службы в оснастке **Active Directory — пользователи и компьютеры.** Теперь необходимо задать **msDS-AllowedToActOnBehalfOfOtherIdentity**.

## <a name="grant-the-gateway-service-account-local-policy-rights-on-the-gateway-machine"></a>Предоставление учетной записи службы шлюза прав на локальные политики на компьютере шлюза

Теперь на компьютере со службой шлюза (в нашем примере это **MyGatewayMachine**) нужно назначить учетной записи службы шлюза локальную политику **Имитация клиента после проверки подлинности** и **Работа в режиме операционной системы (SeTcbPrivilege)** . Эту конфигурацию можно выполнить и проверить с помощью редактора локальных групповых политик (**gpedit**).

1. На компьютере шлюза выполните команду *gpedit.msc*.

2. Выберите **Политика локального компьютера** &gt; **Конфигурация компьютера** &gt; **Параметры Windows** &gt; **Параметры безопасности** &gt; **Локальные политики** &gt; **Назначение прав пользователя**.

    ![Снимок экрана: структура папок политики локального компьютера](media/service-gateway-sso-kerberos/user-rights-assignment.png)

3. В списке политик в разделе **Назначение прав пользователя** выберите **Имитация клиента после проверки подлинности**.

    ![Снимок экрана: политика олицетворения клиента](media/service-gateway-sso-kerberos/impersonate-client.png)

    Щелкните правой кнопкой мыши и выберите **Свойства**. Проверьте список учетных записей. Он должен содержать учетную запись службы шлюза (**Contoso\GatewaySvc** или **ContosoFrontEnd\GatewaySvc** в зависимости от типа ограниченного делегирования).

4. В списке политик в разделе **Назначение прав пользователя** выберите **Работа в режиме операционной системы (SeTcbPrivilege)** . Убедитесь, что учетная запись службы шлюза также входит в список учетных записей.

5. Перезапустите процесс службы **локального шлюза данных**.

### <a name="set-user-mapping-configuration-parameters-on-the-gateway-machine-if-required"></a>Настройка параметров сопоставления пользователей на компьютере шлюза (если потребуется)

Если у вас не настроено средство Azure AD Connect, выполните указанные ниже действия для сопоставления пользователя службы Power BI с локальным пользователем Active Directory. Каждому пользователю Active Directory, которого вы сопоставите таким образом, нужно предоставить права на единый вход для источника данных. Дополнительные сведения см. в [видео Guy in a Cube](https://www.youtube.com/watch?v=NG05PG9aiRw).

1. Откройте главный файл конфигурации шлюза `Microsoft.PowerBI.DataMovement.Pipeline.GatewayCore.dll`. По умолчанию этот файл находится в каталоге C:\Program Files\On-premises data gateway.

1. Для параметра **ADUserNameLookupProperty** укажите неиспользуемый атрибут Active Directory. Мы здесь полагаем, что в следующих шагах используется `msDS-cloudExtensionAttribute1`, хотя этот атрибут доступен только в Windows Server 2012 и более поздних версиях. Задайте для **ADUserNameLookupProperty** значение `SAMAccountName`. Сохраните файл конфигурации.

1. На вкладке **Службы** диспетчера задач щелкните службу шлюза правой кнопкой мыши и выберите команду **Перезапустить**.

    ![Снимок экрана: вкладка "Службы" диспетчера задач](media/service-gateway-sso-kerberos/restart-gateway.png)

1. Для каждого пользователя службы Power BI, которому потребуется единый вход Kerberos, в свойстве `msDS-cloudExtensionAttribute1` локального пользователя Active Directory (с разрешением единого входа для используемого источника данных) укажите полное имя пользователя службы Power BI (то есть имя участника-пользователя). Например, если вы входите в службу Power BI с именем `test@contoso.com` и хотите сопоставить этого пользователя с локальным пользователем Active Directory `test@LOCALDOMAIN.COM` с правами на единый вход, присвойте атрибуту `msDS-cloudExtensionAttribute1` в `test@LOCALDOMAIN.COM` значение `test@contoso.com`.

    Чтобы задать свойство `msDS-cloudExtensionAttribute1`, можно использовать оснастку MMC "Пользователи и компьютеры Active Directory":
    
    1. Войдите как администратор домена и запустите средство "Пользователи и компьютеры Active Directory".
    
    1. Щелкните правой кнопкой мыши домен, выберите "Найти" и введите имя учетной записи того пользователя Active Directory, с которым нужно настроить сопоставление.
    
    1. Выберите вкладку **Редактор атрибутов**.
    
        Найдите свойство `msDS-cloudExtensionAttribute1` и дважды щелкните его. В качестве значения введите полное имя пользователя, которое вы используете для входа в службу Power BI (то есть имя участника-пользователя).
    
    1. Нажмите кнопку **ОК**.
    
        ![Снимок экрана: диалоговое окно "Редактор строковых атрибутов"](media/service-gateway-sso-kerberos/edit-attribute.png)
    
    1. Нажмите кнопку **Применить**. Проверьте, правильно ли установлено значение в столбце **Значение**.

## <a name="complete-data-source-specific-configuration-steps"></a>Выполнение шаги по настройке конкретного источника данных

Для SAP HANA и SAP BW существуют дополнительные требования к конфигурации источника данных и предварительные требования, которые нужно выполнить до настройки единого входа через шлюз для этих источников данных. Дополнительные сведения см. на страницах [конфигурации SAP HANA](service-gateway-sso-kerberos-sap-hana.md) и [конфигурации SAP BW — CommonCryptoLib (sapcrypto.dll)](service-gateway-sso-kerberos-sap-bw-commoncryptolib.md). Также можно [настроить для SAP BW использование библиотеки gx64krb5 SNC](service-gateway-sso-kerberos-sap-bw-gx64krb.md), но корпорация Майкрософт не рекомендует ее применять из-за прекращения поддержки этой библиотеки в SAP. В качестве библиотеки SNC следует использовать CommonCryptoLib _или_ gx64krb5. Не выполняйте настройку обеих библиотек.

> [!NOTE]
> Другие библиотеки SNC также могут работать с единым входом для BW, но официально не поддерживаются корпорацией Майкрософт.

## <a name="run-a-power-bi-report"></a>Запуск отчета Power BI

Выполнив все шаги настройки, на странице **Управление шлюза** в Power BI можно настроить источник данных для единого входа. Если вы используете несколько шлюзов, выберите тот из них, который ранее настроили для единого входа Kerberos. В разделе **Дополнительные параметры** для источника данных установите флажок **Использовать единый вход (SSO) через Kerberos для запросов DirectQuery**.

![Снимок экрана: параметр "Дополнительные параметры"](media/service-gateway-sso-kerberos/advanced-settings.png)

 Опубликуйте отчет **на основе DirectQuery** из Power BI Desktop. Для этого отчета должны использоваться данные, доступные пользователю, который сопоставлен с пользователем Active Directory (Azure), выполняющим вход в службу Power BI. Использовать DirectQuery вместо импорта необходимо из-за особенностей работы импорта. При обновлении отчетов на основе импорта шлюз использует учетные данные, введенные в полях **Имя пользователя** и **Пароль** при создании источника данных. Иными словами, единый вход Kerberos **не** используется. Кроме того, если имеется несколько шлюзов, при публикации нужно выбрать шлюз, настроенный для единого входа. Теперь в службе Power BI вы должны быть в состоянии обновить отчет или создать его на основе опубликованного набора данных.

Эта конфигурация применима для большинства случаев. Но при использовании Kerberos в разных средах могут применяться разные конфигурации. Если отчет по-прежнему не загружается, обратитесь к администратору домена для дальнейшего изучения проблемы. Если в качестве источника данных используется SAP BW, вы можете ознакомиться с разделами по устранению неполадок на страницах настройки, относящихся к источникам данных [CommonCryptoLib](service-gateway-sso-kerberos-sap-bw-commoncryptolib.md#troubleshooting) и [gx64krb5/gsskrb5](service-gateway-sso-kerberos-sap-bw-gx64krb.md#troubleshooting) в зависимости от выбранной библиотеки SNC.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о **локальном шлюзе данных** и **DirectQuery** см. в следующих ресурсах:

* [Что такое локальный шлюз данных?](/data-integration/gateway/service-gateway-onprem)
* [Power BI и DirectQuery](desktop-directquery-about.md)
* [Источники данных, поддерживаемые DirectQuery](desktop-directquery-data-sources.md)
* [Использование DirectQuery и SAP Business Warehouse (BW)](desktop-directquery-sap-bw.md)
* [DirectQuery и SAP HANA](desktop-directquery-sap-hana.md)
